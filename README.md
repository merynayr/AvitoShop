# Магазин мерча для сотрудников

> [Техническое задание](./TASKS.md)


## Оглавление
- [Описание задачи](#описание-задачи)
- [Стек технологий](#стек-технологий)
- [Описание API](#описание-api)
  - [Сценарии использования](#сценарии-использования)
- [Запуск проекта](#запуск-проекта)
- [Документация API](#документация-api)
- [Тесты](#тесты)
- [Как запустить нагрузочное тестирование](#как-запустить-нагрузочное-тестирование)
- [Линтер](#линтер)

## Описание задачи

Сервис позволяет сотрудникам:

- Просматривать список приобретенных товаров.
- Смотреть информацию о движении монеток в их кошельке, включая:
  - Кто передавал монеты и в каком количестве.
  - Кому сотрудник передавал монеты и в каком количестве.

## Стек технологий

- **Язык сервиса:** Go
- **База данных:** PostgreSQL
- **Контейнеризация:** Docker, Docker Compose
- **Авторизация:** JWT

## Описание API

Для работы с API необходимо выполнить авторизацию с использованием JWT. Пользовательский токен доступа выдается после регистрации/авторизации.

### Сценарии использования

1. **Авторизация / Регистрация:** После первой авторизации пользователь создается автоматически.
2. **Покупка товара:** Сотрудники могут покупать мерч, используя монеты.
3. **Передача монет:** Сотрудники могут передавать монеты другим сотрудникам в знак благодарности или подарка.
4. **История транзакций**: Сотрудники могут увидеть историю покупок и ифнормацию о движении монеток в их кошельке


## Запуск проекта

Для запуска сервиса и базы данных необходимо использовать Docker Compose. Инструкция по запуску:

1. Клонируйте репозиторий на свой локальный компьютер.

        git clone git@github.com:merynayr/AvitoShop.git && cd AvitoShop

2. Запустите контейнеры с помощью Docker Compose:

        make docker-build
    или командой

        docker compose up --build -d

3. Вы должны увидеть вывод Docker, подтверждающий, что контейнеры успешно запущены. На этом этапе сервис будет доступен по следующему адресу:

        http://localhost:8080

4. Переменные окружения можно найти в файле .env.

5. Все команды можно найти в Makefile.
## Документация API

После запуска сервиса можно открыть документацию OpenAPI, она запускается на другом порту. Изменить порт можно в файле .env:

- Swagger UI: http://localhost:8093

## Тесты

Тесты выполняются тестовой базе данных в отдельном контейнере с портом 5433. Если менять его, то нужно изменить его в Docker-compose.yml и
Makefile и в файле ./internal/tests/integration_tests/config_test.go

- Необходимо провести миграции командой:
        
        make migration_for_test_up

- Запустить юнит-тесты можно командой:

        go test -v ./internal/tests/unit_tests/...

- Запустить интеграционные тесты можно командой:

        go test -v ./internal/tests/integration_tests/...

- Запустить все тесты можно командной:

        make test

- Запуск тестов с покрытием кода:

        make test-coverage

Будут запущены как юнит-тесты, так и интеграционные.
Все тесты можно найти в папке ./internal/tests.

## Как запустить нагрузочное тестирование

Нагрузочное тестирование проводилось с помощью k6. Тестовый файл: load-test.js. Рекомендую поменять найстройки подключения к БД приложения в файле .env.
    
    make load-testing

Миграции:

        make migration_for_test_up
        make migration_for_test_down

Мой компьютер не выдерживает и 10к пользователей. Запросы начинают тормозить.

    checks.........................: 100.00% 12103 out of 12103
     data_received..................: 3.9 MB  94 kB/s
     data_sent......................: 3.4 MB  81 kB/s
     http_req_blocked...............: avg=58.15µs min=4.19µs  med=8.03µs  max=9.11ms p(90)=190.38µs p(95)=222.37µs
     http_req_connecting............: avg=37.77µs min=0s      med=0s      max=9.05ms p(90)=131.1µs  p(95)=156.74µs
    ✗ http_req_duration..............: avg=2.07s   min=1.26ms  med=2.1s    max=6.73s  p(90)=4.78s    p(95)=5.21s   
        { expected_response:true }...: avg=2.07s   min=1.26ms  med=2.1s    max=6.73s  p(90)=4.78s    p(95)=5.21s   
    ✓ http_req_failed................: 0.00%   0 out of 8645
        http_req_receiving.............: avg=82.59µs min=17.94µs med=61.04µs max=4.12ms p(90)=104.69µs p(95)=190.77µs
        http_req_sending...............: avg=32.08µs min=7.54µs  med=20.39µs max=3.86ms p(90)=46.37µs  p(95)=57.6µs  
        http_req_tls_handshaking.......: avg=0s      min=0s      med=0s      max=0s     p(90)=0s       p(95)=0s      
        http_req_waiting...............: avg=2.07s   min=1.19ms  med=2.1s    max=6.73s  p(90)=4.78s    p(95)=5.21s   
        http_reqs......................: 8645    206.796369/s
        iteration_duration.............: avg=11.37s  min=1.12s   med=13.56s  max=19.72s p(90)=19.27s   p(95)=19.39s  
        iterations.....................: 1729    41.359274/s
        vus............................: 698     min=2              max=1000
        vus_max........................: 1000    min=1000           max=1000

## Линтер

В проекте используется линтер golangci-lint. Чтобы запустить его для проверки кода на ошибки, используйте команду:

    make lint

### Конфигурация линтера
Конфигурация линтера представлена в файле `.golangci.pipeline.yaml`.

